name: dbt Cloud CI/CD (Trigger CI + Deploy)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  dbt_cloud_ci_cd:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Trigger ContinuousIntegrationJob
        id: trigger_ci
        env:
          DBT_CLOUD_API_KEY: ${{ secrets.DBT_CLOUD_API_KEY }}
          DBT_CLOUD_ACCOUNT_ID: ${{ secrets.DBT_CLOUD_ACCOUNT_ID }}
          DBT_CLOUD_CI_JOB_ID: ${{ secrets.DBT_CLOUD_CI_JOB_ID }}
        run: |
          echo "Triggering CI Job..."
          COMMIT_SHA=${{ github.sha }}
          RESP=$(curl -s -X POST \
            "https://cloud.getdbt.com/api/v2/accounts/${DBT_CLOUD_ACCOUNT_ID}/jobs/${DBT_CLOUD_CI_JOB_ID}/run/" \
            -H "Authorization: Bearer ${DBT_CLOUD_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"cause":"CI/CD push trigger","git_sha":"'"${COMMIT_SHA}"'"}')
          echo "Raw response: $RESP"
          RUN_ID=$(echo "$RESP" | jq -r '.data.id // empty')
          if [ -z "$RUN_ID" ]; then
            echo "Failed to create CI run. Full response:"
            echo "$RESP"
            exit 1
          fi
          echo "ci_run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Poll ContinuousIntegrationJob status
        id: poll_ci
        env:
          DBT_CLOUD_API_KEY: ${{ secrets.DBT_CLOUD_API_KEY }}
          DBT_CLOUD_ACCOUNT_ID: ${{ secrets.DBT_CLOUD_ACCOUNT_ID }}
        run: |
          RUN_ID=${{ steps.trigger_ci.outputs.ci_run_id }}
          MAX_ATTEMPTS=30
          INTERVAL=10
          ATTEMPT=0
          echo "Polling CI Job run ${RUN_ID}"
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            sleep $INTERVAL
            ATTEMPT=$((ATTEMPT+1))
            STATUS=$(curl -s -H "Authorization: Bearer ${DBT_CLOUD_API_KEY}" \
              "https://cloud.getdbt.com/api/v2/accounts/${DBT_CLOUD_ACCOUNT_ID}/runs/${RUN_ID}/" \
              | jq -r '.data.status')
            if [ "$STATUS" = "3" ]; then
              echo "CI run succeeded"
              exit 0
            fi
            if [ "$STATUS" = "4" ] || [ "$STATUS" = "5" ]; then
              echo "CI run failed or cancelled"
              exit 1
            fi
          done
          echo "CI run timed out"
          exit 1

      - name: Trigger Deploy Job
        if: success()
        id: trigger_deploy
        env:
          DBT_CLOUD_API_KEY: ${{ secrets.DBT_CLOUD_API_KEY }}
          DBT_CLOUD_ACCOUNT_ID: ${{ secrets.DBT_CLOUD_ACCOUNT_ID }}
          DBT_CLOUD_DEPLOY_JOB_ID: ${{ secrets.DBT_CLOUD_DEPLOY_JOB_ID }}
        run: |
          echo "Triggering Deploy Job..."
          COMMIT_SHA=${{ github.sha }}
          RESP=$(curl -s -X POST \
            "https://cloud.getdbt.com/api/v2/accounts/${DBT_CLOUD_ACCOUNT_ID}/jobs/${DBT_CLOUD_DEPLOY_JOB_ID}/run/" \
            -H "Authorization: Bearer ${DBT_CLOUD_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"cause":"CI/CD push trigger","git_sha":"'"${COMMIT_SHA}"'"}')
          echo "Raw response: $RESP"
          RUN_ID=$(echo "$RESP" | jq -r '.data.id // empty')
          if [ -z "$RUN_ID" ]; then
            echo "Failed to create Deploy run. Full response:"
            echo "$RESP"
            exit 1
          fi
          echo "deploy_run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Poll Deploy Job status
        if: success()
        id: poll_deploy
        env:
          DBT_CLOUD_API_KEY: ${{ secrets.DBT_CLOUD_API_KEY }}
          DBT_CLOUD_ACCOUNT_ID: ${{ secrets.DBT_CLOUD_ACCOUNT_ID }}
        run: |
          RUN_ID=${{ steps.trigger_deploy.outputs.deploy_run_id }}
          MAX_ATTEMPTS=60
          INTERVAL=10
          ATTEMPT=0
          echo "Polling Deploy Job run ${RUN_ID}"
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            sleep $INTERVAL
            ATTEMPT=$((ATTEMPT+1))
            STATUS=$(curl -s -H "Authorization: Bearer ${DBT_CLOUD_API_KEY}" \
              "https://cloud.getdbt.com/api/v2/accounts/${DBT_CLOUD_ACCOUNT_ID}/runs/${RUN_ID}/" \
              | jq -r '.data.status')
            if [ "$STATUS" = "3" ]; then
              echo "Deploy run succeeded"
              exit 0
            fi
            if [ "$STATUS" = "4" ] || [ "$STATUS" = "5" ]; then
              echo "Deploy run failed or cancelled"
              exit 1
            fi
          done
          echo "Deploy run timed out"
          exit 1
